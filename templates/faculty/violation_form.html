{% extends "faculty/alt_layout.html" %} {% block title %}SCDS - Violation FOrms{%
endblock title %} {% block styles %}
<style>
    .e-headertext {
      color: white;
      font-weight: bolder !important;
      font-size: 16px !important;
    }
  
    th.e-headercell {
      background-color: #6376eb !important;
      color: white;
    }
  
    /* Table styles */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
  
    th,
    td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: left;
    }
  
    /* Alternate row colors */
    tbody tr:nth-child(even) {
      background-color: #f2f2f2;
    }
  
    /* Hover effect */
    tbody tr:hover {
      background-color: #ddd;
    }
  
    /* Adjust text color */
    tbody td {
      color: #333;
    }
</style>
{% endblock %} {% block content %}
<div class="p-4 md:ml-72">
  <div class="border-2 border-gray-200 border-dashed rounded-lg">
    <div class="grid grid-cols-1">
      <div class="rounded-sm border border-stroke bg-white p-4 md:p-6 xl:p-7.5 shadow-sm">
        <h3 class="text-2xl font-bold text-c4 mb-3 px-4" id="name-number">Violation Form</h3>
        <hr class="mx-2" />

        <form class="w-full mt-4" method="POST" id="submitReport" action="{{ url_for('faculty_api.reporting_violation') }}">
          <div class="grid gap-6 mb-6 md:grid-cols-2">
            <!-- INPUTS HERE -->
            <div>
              <label for="date-input" class="block mb-2 text-c1 font-extrabold"
                >Date</label
              >
              <input
                type="date"
                id="date-input"
                name="date"
                class="bg-gray-50 border border-gray-300 font-normal text-c1 text-sm focus:ring-primary focus:border-secondary block w-full px-2 py-1"
                required <!-- Add the required attribute -->
              <p id="error-date" class="text-c4 text-sm"></p>
            </div>

            <div>
              <label for="time-input" class="block mb-2 text-c1 font-extrabold"
                >Time</label
              >
              <input
                type="time"
                id="time-input"
                name="time"
                class="bg-gray-50 border border-gray-300 font-normal text-c1 text-sm focus:ring-primary focus:border-secondary block w-full px-2 py-1"
                required <!-- Add the required attribute -->
              <p id="error-time" class="text-c4 text-sm"></p>
            </div>

            <div>
              <label for="incident-input" class="block mb-2 text-c1 font-extrabold">Violation Type</label>
              <select id="incident-input" name="incident" class="select2 bg-gray-50 border border-gray-300 font-normal text-c1 text-sm focus:ring-primary focus:border-secondary block w-full px-2 py-1" required>
                  {% for incident_type in incident_types|sort(attribute='Name') %}
                      <option value="{{ incident_type.IncidentTypeId }}">{{ incident_type.Name }}</option>
                  {% endfor %}
              </select>
              <p id="error-incident" class="text-c4 text-sm"></p>
            </div>
            
          
            <div>
              <label for="location-input" class="block mb-2 text-c1 font-extrabold">Location</label>
              <select id="location-input" name="location" class="select2 bg-gray-50 border border-gray-300 font-normal text-c1 text-sm focus:ring-primary focus:border-secondary block w-full px-2 py-1" required>
                  {% for location in locations %}
                      <option value="{{ location.LocationId }}">{{ location.Name }}</option>
                  {% endfor %}
              </select>
              <p id="error-location" class="text-c4 text-sm"></p>
            </div>
          

          <div>
            <label for="student-input" class="block mb-2 text-c1 font-extrabold">Select Student</label>
            <select
              id="student-input"
              name="student"
              class="bg-gray-50 border border-gray-300 font-normal text-c1 text-sm focus:ring-primary focus:border-secondary block w-full px-2 py-1"
              required <!-- Add the required attribute -->
              {% for Student in students|sort(attribute='LastName') %}
                <option value="{{ Student.StudentId }}">{{ Student.LastName }}, {{ Student.FirstName }} {{ Student.MiddleName }}</option>
              {% endfor %}
            </select>
            <p id="error-student" class="text-c4 text-sm"></p>
          </div>
          
          
          
            
            <div>
              <label for="description-input" class="block mb-2 text-c1 font-extrabold"
                >Description</label
              >
              <input
                type="text"
                id="description-input"
                name="description"
                class="bg-gray-50 border border-gray-300 font-normal text-c1 text-sm focus:ring-primary focus:border-secondary block w-full px-2 py-1"
                required <!-- Add the required attribute -->
              <p id="error-description" class="text-c4 text-sm"></p>
            </div>

          <button
            type="submit"
            class="text-white bg-c4 hover:bg-c5 transition duration-300 font-bold text-sm sm:w-auto px-5 px-5 py-2 text-center"
          >
            Submit
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block script %}
<!-- Include Notyf script -->
<script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>

<script>
 
document.getElementById('submitReport').addEventListener('submit', function(event) {
  event.preventDefault(); // Prevent the default form submission
  
  // Check if the form is valid
  if (!event.target.checkValidity()) {
      // If the form is invalid, display error messages for each input field
      event.target.querySelectorAll(':invalid').forEach((element) => {
          const errorMessage = element.parentNode.querySelector(`#error-${element.id}`);
          if (errorMessage) {
              errorMessage.textContent = `${element.name} is required.`;
          }
      });
      return; // Exit the function without submitting the form
  }
  
  // If the form is valid, proceed with form submission
  const formData = new FormData(event.target);
  const apiUrl = "{{ url_for('faculty_api.reporting_violation') }}";
  
  fetch(apiUrl, {
      method: 'POST',
      body: formData,
      credentials: 'include',
  })
  .then((response) => {
      if (!response.ok) {
          throw new Error('Failed to submit report');
      }
      return response.json();
  })
  .then((data) => {
    // If the API returned a success message, display it and redirect to the dashboard
    console.log('success:', data);
    if (data.success) {
      notyf.success(data.message);
    // remove all the field values upon successful submission
    document.getElementById('date-input').value = '';
    document.getElementById('time-input').value = '';
    document.getElementById('description-input').value = '';
    document.getElementById('incident-input').value = '';
    document.getElementById('location-input').value = '';
    document.getElementById('student-input').value = '';
    } else {
      // If the API returned an error message, display it
      notyf.error(data.message);
    }
  })
  .catch((error) => {
    // Hanndle errors
      console.error('Error submitting Violation:', error.message);
      notyf.error('Failed to submit Violation');
  });
});
</script>

//<!-- FETCHING USER DETAILS -->
<script>
  // Variables to store location and incident types
  let locationDetails = {};
  let incidentTypes = {};

  // Fetch location and incident types
  async function fetchLocation() {
    try {
      // Fetch location data
      const locationResponse = await fetch(`${api_base_url}/location`);

      if (!locationResponse.ok) {
        throw new Error('Failed to fetch location data');
      }

      locationDetails = await locationResponse.json();
      
      updateDropdowns();
      // Fetch incident types
      const incidentResponse = await fetch(`${api_base_url}/incident_types`);
      if (!incidentResponse.ok) {
        throw new Error('Failed to fetch incident types data');
      }
      incidentTypes = await incidentResponse.json();
      updateDropdowns();
    } catch (error) {
      console.error(error.message);
    }
  }

  // Function to update dropdowns with location and incident types
  function updateDropdowns() {
    const incidentDropdown = document.getElementById('incident-input');
    incidentDropdown.innerHTML = '';
    for (const incidentType of incidentTypes) {
      const option = document.createElement('option');
      option.value = incidentType.IncidentTypeId;
      option.text = incidentType.Name;
      incidentDropdown.appendChild(option);
    }

    const locationDropdown = document.getElementById('location-input');
    locationDropdown.innerHTML = '';
    for (const location of locationDetails) {
      const option = document.createElement('option');
      option.value = location.LocationId;
      option.text = location.Name;
      locationDropdown.appendChild(option);
    }
  }

  // Initial fetch when the page loads
  fetchLocation();
</script>

{% endblock script %}